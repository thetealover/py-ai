<!-- templates/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FastAPI LangGraph SSE Chat</title>
    <!-- Include the Marked.js library for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f4f9; }
        #chat-container { width: 600px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 80vh; background-color: white; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #eee; }
        #input-container { display: flex; padding: 10px; }
        #userInput { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .message { margin-bottom: 15px; }
        .user-message { text-align: right; }
        .bot-message p, .user-message p { display: inline-block; padding: 10px 15px; border-radius: 18px; max-width: 80%; text-align: left; }
        .user-message p { background-color: #007bff; color: white; }
        .bot-message p { background-color: #e9ecef; color: #333; }
        .tool-message { text-align: center; color: #888; font-style: italic; font-size: 0.9em; margin-bottom: 10px; }
        strong { font-weight: 600; }
        code { background-color: #f0f0f0; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        pre { background-color: #f0f0f0; padding: 10px; border-radius: 4px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-container">
            <input id="userInput" type="text" placeholder="Type your message here..." autofocus>
        </div>
    </div>

    <script>
        const userInput = document.getElementById('userInput');
        const messagesDiv = document.getElementById('messages');

        // Generate a unique session ID for this chat session
        const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);

        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = userInput.value;
            if (message.trim() === '') return;

            // Display user message
            const userMsgHtml = `<div class="message user-message"><p><strong>You:</strong> ${message}</p></div>`;
            messagesDiv.insertAdjacentHTML('beforeend', userMsgHtml);
            userInput.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Create a container for the bot's response
            const botMsgContainer = document.createElement('div');
            botMsgContainer.className = 'message bot-message';
            botMsgContainer.innerHTML = `<p><strong>Bot:</strong> </p>`;
            messagesDiv.appendChild(botMsgContainer);
            const botParagraph = botMsgContainer.querySelector('p');
            let fullBotResponse = '';

            try {
                const response = await fetch('/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, session_id: sessionId })
                });

                const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const lines = value.split('\n\n').filter(line => line.trim());
                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            const dataStr = line.substring(5);
                            const data = JSON.parse(dataStr);

                            if (data.type === 'chunk') {
                                fullBotResponse += data.data;
                                // Use marked.parse to render Markdown in real-time
                                botParagraph.innerHTML = `<strong>Bot:</strong> ${marked.parse(fullBotResponse)}`;
                            } else if (data.type === 'tool_start') {
                                // Display the tool usage message before the bot's final response
                                const toolMsgHtml = `<div class="tool-message">${data.data}</div>`;
                                messagesDiv.insertAdjacentHTML('beforeend', toolMsgHtml);
                            } else if (data.type === 'end') {
                                return; // Stream finished
                            }
                        }
                    }
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            } catch (err) {
                console.error("Request failed:", err);
                botParagraph.innerHTML += "<br><em>Sorry, something went wrong.</em>";
            }
        }
    </script>
</body>
</html>